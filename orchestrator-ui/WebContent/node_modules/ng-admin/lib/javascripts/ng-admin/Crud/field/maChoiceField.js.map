{"version":3,"sources":["../../../../../src/javascripts/ng-admin/Crud/field/maChoiceField.js"],"names":["maChoiceField","updateChoices","scope","choices","$root","$$phase","$digest","$compile","restrict","compile","pre","element","field","attributes","placeholder","name","v","validation","$watch","newValue","oldValue","undefined","value","refreshAttributes","itemsFilter","type","indexOf","remoteComplete","refreshDelay","remoteCompleteOptions","choicesFactory","entry","template","newEntry","oldEntry","oldChoices","angular","equals","html","select","children","setAttribute","contents","post","$on","e","data","$inject"],"mappings":"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","file":"maChoiceField.js","sourcesContent":["function updateChoices(scope, choices) {\n    scope.choices = choices;\n    scope.$root.$$phase || scope.$digest();\n}\n\nexport default function maChoiceField($compile) {\n    return {\n        scope: {\n            'field': '&',\n            'value': '=',\n            'entry':  '=?',\n            'datastore': '&?',\n            'refresh': '&',\n            'choices': '&?'\n        },\n        restrict: 'E',\n        compile: function() {\n            return {\n                pre: function(scope, element) {\n                    var field = scope.field();\n                    var attributes = field.attributes();\n                    scope.placeholder = (attributes && attributes.placeholder) || 'FILTER_VALUES';\n                    scope.name = field.name();\n                    scope.v = field.validation();\n                    scope.$watch('value', function(newValue, oldValue) {\n                        if (newValue !== oldValue && newValue === undefined) {\n                            // fix for https://github.com/angular-ui/ui-select/issues/863\n                            scope.value = null;\n                        }\n                    });\n\n                    var refreshAttributes = '';\n                    var itemsFilter = '| filter: {label: $select.search}';\n                    if (field.type().indexOf('reference') === 0 && field.remoteComplete()) { // FIXME wrong place to do that\n                        scope.refreshDelay = field.remoteCompleteOptions().refreshDelay;\n                        refreshAttributes = 'refresh-delay=\"refreshDelay\" refresh=\"refresh({ $search: $select.search })\"';\n                        itemsFilter = '';\n                    }\n\n                    const choices = scope.choices ? scope.choices : field.choices ? field.choices() : [];\n                    let choicesFactory;\n\n                    if (typeof choices === 'function' && choices(scope.entry)) {\n                        choicesFactory = choices;\n                        scope.choices = choicesFactory(scope.entry);\n                    } else {\n                        scope.choices = choices ? choices : [];\n                    }\n\n                    var template = `\n                        <ui-select ng-model=\"$parent.value\" ng-required=\"v.required\" id=\"{{ name }}\" name=\"{{ name }}\">\n                            <ui-select-match allow-clear=\"{{ !v.required }}\" placeholder=\"{{ placeholder | translate }}\">{{ $select.selected.label | translate }}</ui-select-match>\n                            <ui-select-choices ${refreshAttributes} repeat=\"item.value as item in choices ${itemsFilter} track by $index\">\n                                {{ item.label | translate }}\n                            </ui-select-choices>\n                        </ui-select>`;\n\n                    // as choices may be a function depending of another entry field, we need to watch the whole entry\n                    scope.$watch('entry', (newEntry, oldEntry) => {\n                        if (!choicesFactory) {\n                            return;\n                        }\n\n                        const oldChoices = scope.choices;\n                        scope.choices = choicesFactory(newEntry);\n                        if (!angular.equals(scope.choices, oldChoices)) {\n                            scope.value = null;\n                        }\n                    }, true);\n\n                    element.html(template);\n\n                    var select = element.children()[0];\n                    for (var name in attributes) {\n                        select.setAttribute(name, attributes[name]);\n                    }\n\n                    $compile(element.contents())(scope);\n                },\n                post: function(scope) {\n                    scope.$on('choices:update', function(e, data) {\n                        updateChoices(scope, data.choices);\n                    });\n                }\n            };\n        }\n    };\n}\n\nmaChoiceField.$inject = ['$compile'];\n"]}